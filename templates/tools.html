{% extends "base.html" %}

{% block title %}PDF Tools - Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto text-center">
            <h1 class="display-4 fw-bold mb-3 text-dark">SnapPDF Tools</h1>
            <p class="lead text-secondary">Professional-grade PDF tools. Fast, secure, and entirely in your browser.</p>
            {% if not current_user.is_premium %}
            <div class="card bg-white border shadow-sm d-inline-block p-2">
                <div class="card-body py-2 px-3">
                    <i class="fas fa-bolt text-warning me-2"></i> 
                    <span class="small fw-bold text-dark">Free Plan:</span> <span class="small text-secondary">5MB limit per file.</span> 
                    <a href="{{ url_for('premium') }}" class="small fw-bold text-primary ms-2 text-decoration-none">Go Pro for unlimited size →</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- File Upload Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 bg-transparent">
                <div class="card-body p-0">
                    <div class="upload-area shadow-sm" id="uploadArea">
                        <div class="mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-circle p-4 mb-3">
                                <i class="fas fa-cloud-upload-alt text-primary" style="font-size: 3.5rem;"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold mb-3">Ready to process?</h2>
                        <p class="text-muted fs-5 mb-4">Drag & drop your files here or use the button below</p>
                        <button class="btn btn-primary btn-lg px-5 shadow-sm mb-4" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-plus me-2"></i>Choose Files
                        </button>
                        <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
                        <div class="mt-3">
                            <small class="text-muted">
                                {% if current_user.is_premium %}
                                    <i class="fas fa-bolt text-warning"></i> SnapPDF Pro: 100MB limits & priority queue
                                {% else %}
                                    <i class="fas fa-info-circle"></i> Free: 5MB per file | Max 3 files per batch
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Tools -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center mb-4">
                <h4 class="mb-0 fw-bold">All PDF Tools</h4>
                <div class="ms-3 badge bg-light text-dark border shadow-sm">
                    <i class="fas fa-search me-1"></i> Filter tools
                </div>
            </div>

            <!-- ORGANIZE PDF -->
            <div class="mb-5">
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="letter-spacing: 1px;">Organize PDF</h6>
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('merge')">
                            <div class="card-body p-3">
                                <i class="fas fa-layer-group text-danger mb-2 fs-4"></i>
                                <h6 class="mb-1">Merge PDF</h6>
                                <p class="text-muted small mb-0">Combine files</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('split')">
                            <div class="card-body p-3">
                                <i class="fas fa-cut text-danger mb-2 fs-4"></i>
                                <h6 class="mb-1">Split PDF</h6>
                                <p class="text-muted small mb-0">Separate pages</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('remove-pages')">
                            <div class="card-body p-3">
                                <i class="fas fa-times-circle text-danger mb-2 fs-4"></i>
                                <h6 class="mb-1">Remove pages</h6>
                                <p class="text-muted small mb-0">Delete content</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('extract-pages')">
                            <div class="card-body p-3">
                                <i class="fas fa-sign-out-alt text-danger mb-2 fs-4"></i>
                                <h6 class="mb-1">Extract pages</h6>
                                <p class="text-muted small mb-0">Get specific parts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('organize')">
                            <div class="card-body p-3">
                                <i class="fas fa-th-large text-danger mb-2 fs-4"></i>
                                <h6 class="mb-1">Organize PDF</h6>
                                <p class="text-muted small mb-0">Rearrange pages</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('scan-to-pdf')">
                            <div class="card-body p-3">
                                <i class="fas fa-scanner text-danger mb-2 fs-4"></i>
                                <h6 class="mb-1">Scan to PDF</h6>
                                <p class="text-muted small mb-0">Images to PDF</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OPTIMIZE PDF -->
            <div class="mb-5">
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="letter-spacing: 1px;">Optimize PDF</h6>
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('compress')">
                            <div class="card-body p-3">
                                <i class="fas fa-compress-arrows-alt text-success mb-2 fs-4"></i>
                                <h6 class="mb-1">Compress PDF</h6>
                                <p class="text-muted small mb-0">Reduce size</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('repair')">
                            <div class="card-body p-3">
                                <i class="fas fa-tools text-success mb-2 fs-4"></i>
                                <h6 class="mb-1">Repair PDF</h6>
                                <p class="text-muted small mb-0">Fix corrupted</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('ocr')">
                            <div class="card-body p-3">
                                <i class="fas fa-eye text-success mb-2 fs-4"></i>
                                <h6 class="mb-1">OCR PDF</h6>
                                <p class="text-muted small mb-0">Searchable text</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONVERT TO PDF -->
            <div class="mb-5">
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="letter-spacing: 1px;">Convert to PDF</h6>
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('jpg_to_pdf')">
                            <div class="card-body p-3">
                                <i class="fas fa-image text-warning mb-2 fs-4"></i>
                                <h6 class="mb-1">JPG to PDF</h6>
                                <p class="text-muted small mb-0">Images to PDF</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('word_to_pdf')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-word text-warning mb-2 fs-4"></i>
                                <h6 class="mb-1">WORD to PDF</h6>
                                <p class="text-muted small mb-0">Docx to PDF</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('powerpoint_to_pdf')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-powerpoint text-warning mb-2 fs-4"></i>
                                <h6 class="mb-1">POWERPOINT to PDF</h6>
                                <p class="text-muted small mb-0">PPTX to PDF</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('excel_to_pdf')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-excel text-warning mb-2 fs-4"></i>
                                <h6 class="mb-1">EXCEL to PDF</h6>
                                <p class="text-muted small mb-0">XLSX to PDF</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('html_to_pdf')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-code text-warning mb-2 fs-4"></i>
                                <h6 class="mb-1">HTML to PDF</h6>
                                <p class="text-muted small mb-0">HTML to PDF</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONVERT FROM PDF -->
            <div class="mb-5">
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="letter-spacing: 1px;">Convert from PDF</h6>
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('pdf_to_jpg')">
                            <div class="card-body p-3">
                                <i class="fas fa-image text-primary mb-2 fs-4"></i>
                                <h6 class="mb-1">PDF to JPG</h6>
                                <p class="text-muted small mb-0">Doc to images</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('convert_word')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-word text-primary mb-2 fs-4"></i>
                                <h6 class="mb-1">PDF to WORD</h6>
                                <p class="text-muted small mb-0">PDF to docx</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('pdf_to_powerpoint')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-powerpoint text-primary mb-2 fs-4"></i>
                                <h6 class="mb-1">PDF to POWERPOINT</h6>
                                <p class="text-muted small mb-0">PDF to pptx</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('pdf_to_excel')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-excel text-primary mb-2 fs-4"></i>
                                <h6 class="mb-1">PDF to EXCEL</h6>
                                <p class="text-muted small mb-0">PDF to xlsx</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('pdf_to_pdfa')">
                            <div class="card-body p-3">
                                <i class="fas fa-file-pdf text-primary mb-2 fs-4"></i>
                                <h6 class="mb-1">PDF to PDF/A</h6>
                                <p class="text-muted small mb-0">Archive format</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EDIT PDF -->
            <div class="mb-5">
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="letter-spacing: 1px;">Edit PDF</h6>
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="showRotateDialog()">
                            <div class="card-body p-3">
                                <i class="fas fa-redo text-info mb-2 fs-4"></i>
                                <h6 class="mb-1">Rotate PDF</h6>
                                <p class="text-muted small mb-0">Fix orientation</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('add_page_numbers')">
                            <div class="card-body p-3">
                                <i class="fas fa-list-ol text-info mb-2 fs-4"></i>
                                <h6 class="mb-1">Add page numbers</h6>
                                <p class="text-muted small mb-0">Stay organized</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="showWatermarkDialog()">
                            <div class="card-body p-3">
                                <i class="fas fa-stamp text-info mb-2 fs-4"></i>
                                <h6 class="mb-1">Add watermark</h6>
                                <p class="text-muted small mb-0">Protect branding</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PDF SECURITY -->
            <div class="mb-5">
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="letter-spacing: 1px;">PDF Security</h6>
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="showUnlockDialog()">
                            <div class="card-body p-3">
                                <i class="fas fa-unlock text-secondary mb-2 fs-4"></i>
                                <h6 class="mb-1">Unlock PDF</h6>
                                <p class="text-muted small mb-0">Remove password</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="showProtectDialog()">
                            <div class="card-body p-3">
                                <i class="fas fa-lock text-secondary mb-2 fs-4"></i>
                                <h6 class="mb-1">Protect PDF</h6>
                                <p class="text-muted small mb-0">Add password</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card tool-card h-100 border-0 shadow-sm" onclick="selectTool('sign')">
                            <div class="card-body p-3">
                                <i class="fas fa-pen-nib text-secondary mb-2 fs-4"></i>
                                <h6 class="mb-1">Sign PDF</h6>
                                <p class="text-muted small mb-0">Digital signature</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Tool Options -->
    <div class="modal fade" id="toolOptionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Tool Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modalConfirmBtn">Start Processing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Jobs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Jobs</h5>
                </div>
                <div class="card-body">
                    {% if recent_jobs %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Job Type</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in recent_jobs %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary">{{ job.job_type.value.title() }}</span>
                                        </td>
                                        <td>
                                            {% if job.status.value == 'completed' %}
                                                <span class="badge bg-success">{{ job.status.value.title() }}</span>
                                            {% elif job.status.value == 'failed' %}
                                                <span class="badge bg-danger">{{ job.status.value.title() }}</span>
                                            {% elif job.status.value == 'processing' %}
                                                <span class="badge bg-info">{{ job.status.value.title() }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">{{ job.status.value.title() }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ job.progress }}%">
                                                    {{ job.progress }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if job.status.value == 'completed' %}
                                                <a href="{{ url_for('download_job_results', job_id=job.id) }}" class="btn btn-sm btn-success">
                                                    <i class="fas fa-download"></i> Download
                                                </a>
                                            {% elif job.status.value in ['pending', 'processing'] %}
                                                <button class="btn btn-sm btn-warning" onclick="cancelJob('{{ job.id }}')">
                                                    <i class="fas fa-times"></i> Cancel
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-history text-muted mb-3" style="font-size: 3rem;"></i>
                            <h5>No recent jobs</h5>
                            <p class="text-muted">Upload files and process them to see your job history</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedTool = null;
let uploadedFiles = [];

// File upload handling
document.getElementById('fileInput').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    uploadFiles(files);
}

    function uploadFiles(files) {
        // Validate files before adding them
        const validFiles = [];
        const errors = [];
        const isPremium = {{ 'true' if current_user.is_premium else 'false' }};
        const fileLimit = isPremium ? 100 * 1024 * 1024 : 5 * 1024 * 1024;
        const batchLimit = isPremium ? 100 : 3;
        
        files.forEach(file => {
            if (file.type !== 'application/pdf') {
                errors.push(`${file.name} is not a PDF file`);
                return;
            }
            
            if (file.size > fileLimit) {
                const limitText = isPremium ? "100MB" : "5MB";
                const upgradePrompt = isPremium ? "" : ". <a href='/premium' class='fw-bold text-primary'>Upgrade to Pro for 100MB limits →</a>";
                errors.push(`${file.name} exceeds ${limitText} limit${upgradePrompt}`);
                return;
            }
            
            validFiles.push(file);
        });
        
        if (errors.length > 0) {
            const errorContainer = document.createElement('div');
            errorContainer.innerHTML = errors.join('<br>');
            showMessage(errorContainer.innerHTML, 'error');
            return;
        }
        
        if (validFiles.length > batchLimit) {
            const upgradePrompt = isPremium ? "" : " <a href='/premium' class='fw-bold text-primary'>Go Pro for batch processing up to 100 files →</a>";
            showMessage(`Free tier limit: ${batchLimit} files per batch.${upgradePrompt}`, 'warning');
            return;
        }
    
    uploadedFiles = validFiles;
    updateUploadArea();
    
    if (validFiles.length > 0) {
        showMessage(`${validFiles.length} file(s) ready for processing`, 'success');
    }
}

function updateUploadArea() {
    const uploadArea = document.getElementById('uploadArea');
    if (uploadedFiles.length > 0) {
        let filesList = '';
        uploadedFiles.forEach((file, index) => {
            filesList += `<div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-white border rounded shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="bg-danger bg-opacity-10 rounded p-2 me-3">
                        <i class="fas fa-file-pdf text-danger fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-dark">${file.name}</div>
                        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                </div>
                <button class="btn btn-link text-muted p-0" onclick="removeFile(${index})">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>`;
        });
        
        uploadArea.innerHTML = `
            <div class="text-start">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0">${uploadedFiles.length} file(s) selected</h4>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearFiles()">
                        <i class="fas fa-times me-1"></i> Clear All
                    </button>
                </div>
                <div class="mt-3" style="max-height: 400px; overflow-y: auto;">
                    ${filesList}
                </div>
                <div class="mt-4 pt-4 border-top text-center">
                    <p class="text-muted small mb-0">
                        <i class="fas fa-shield-alt text-success me-1"></i> Your files are secure and will be auto-deleted in 24 hours.
                    </p>
                    <p class="text-muted small mt-2">Choose a tool below to start processing.</p>
                </div>
            </div>
        `;
    }
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    if (uploadedFiles.length === 0) {
        clearFiles();
    } else {
        updateUploadArea();
    }
}

function clearFiles() {
    uploadedFiles = [];
    selectedTool = null;
    
    // Clear the file input value safely
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.value = '';
    }
    
    const uploadArea = document.getElementById('uploadArea');
        uploadArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt mb-3" style="font-size: 3rem; color: #6c757d;"></i>
        <h5>Drag & Drop PDF Files</h5>
        <p class="text-muted">or <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">Browse Files</button></p>
        <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
        <div class="mt-3">
            <small class="text-muted">
                {% if current_user.is_premium %}
                    <i class="fas fa-bolt text-warning"></i> SnapPDF Pro: Unlimited files & priority queue
                {% else %}
                    <i class="fas fa-info-circle"></i> Free: 5MB per file | Max 3 files per batch
                {% endif %}
            </small>
        </div>
    `;
    
    // Re-attach event listeners after the DOM is updated
    setTimeout(() => {
        const newFileInput = document.getElementById('fileInput');
        if (newFileInput) {
            newFileInput.addEventListener('change', handleFileSelect);
        }
        
        // Re-attach drag and drop listeners
        setupDragAndDrop();
    }, 0);
    
    showMessage('Files cleared successfully', 'info');
}

function selectTool(tool, settings = {}) {
    selectedTool = tool;
    
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    
    // Process files with optional settings
    processFiles(settings);
}

function showProtectDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Protect PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="pdfPassword" class="form-control" placeholder="Enter password to protect PDF">
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const password = document.getElementById('pdfPassword').value;
        if (!password) {
            alert('Please enter a password');
            return;
        }
        modal.hide();
        selectTool('protect', { password: password });
    };
    modal.show();
}

function showRotateDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Rotate PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Rotation Angle</label>
            <select id="pdfRotation" class="form-select">
                <option value="90">90° Clockwise</option>
                <option value="180">180°</option>
                <option value="270">270° Clockwise</option>
            </select>
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const rotation = document.getElementById('pdfRotation').value;
        modal.hide();
        selectTool('rotate', { rotation: rotation });
    };
    modal.show();
}

function showWatermarkDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Watermark PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Watermark Text</label>
            <input type="text" id="watermarkText" class="form-control" placeholder="CONFIDENTIAL" value="CONFIDENTIAL">
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const text = document.getElementById('watermarkText').value;
        if (!text) {
            alert('Please enter watermark text');
            return;
        }
        modal.hide();
        selectTool('watermark', { watermark_text: text });
    };
    modal.show();
}

function showUnlockDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Unlock PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="unlockPassword" class="form-control" placeholder="Enter password to unlock PDF">
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const password = document.getElementById('unlockPassword').value;
        if (!password) {
            alert('Please enter the password');
            return;
        }
        modal.hide();
        selectTool('unlock', { password: password });
    };
    modal.show();
}

function processFiles(settings = {}) {
    // Show processing indicator
    setProcessingState(true);
    
    // First upload the files
    const formData = new FormData();
    for (let file of uploadedFiles) {
        formData.append('files', file);
    }
    
    // Upload files first
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.files) {
            // Files uploaded successfully, now process them
            const fileIds = data.files.map(file => file.id);
            
            // Create processing job
            return fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    job_type: selectedTool,
                    file_ids: fileIds,
                    settings: settings
                })
            });
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    })
    .then(response => response.json())
    .then(data => {
        setProcessingState(false);
        if (data.job_id) {
            showMessage('Processing started successfully! Your files are being processed.', 'success');
            clearFiles();
            setTimeout(() => location.reload(), 2000);
        } else {
            showMessage('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        setProcessingState(false);
        showMessage('An error occurred: ' + error.message, 'error');
    });
}

function cancelJob(jobId) {
    if (confirm('Are you sure you want to cancel this job?')) {
        fetch(`/cancel-job/${jobId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Job cancelled successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while cancelling the job', 'error');
        });
    }
}

function showMessage(message, type) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.custom-message');
    existingMessages.forEach(msg => msg.remove());
    
    // Create new message
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type} alert-dismissible fade show custom-message`;
    messageDiv.style.position = 'fixed';
    messageDiv.style.top = '20px';
    messageDiv.style.right = '20px';
    messageDiv.style.zIndex = '9999';
    messageDiv.style.minWidth = '300px';
    
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(messageDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentElement) {
            messageDiv.remove();
        }
    }, 5000);
}

function setProcessingState(processing) {
    const toolButtons = document.querySelectorAll('.tool-card button');
    const uploadArea = document.getElementById('uploadArea');
    
    if (processing) {
        // Disable all tool buttons
        toolButtons.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        });
        
        // Show processing message in upload area
        if (uploadedFiles.length > 0) {
            uploadArea.innerHTML = `
                <i class="fas fa-spinner fa-spin text-primary mb-3" style="font-size: 3rem;"></i>
                <h5>Processing Files...</h5>
                <p class="text-muted">Please wait while your files are being processed</p>
            `;
        }
    } else {
        // Re-enable tool buttons
        toolButtons.forEach((btn, index) => {
            btn.disabled = false;
            const toolNames = ['Select', 'Select', 'Select', 'Select', 'Select', 'Select'];
            const toolTypes = ['merge', 'split', 'compress', 'ocr', 'convert_word', 'convert_excel'];
            btn.innerHTML = 'Select';
            btn.onclick = () => selectTool(toolTypes[index]);
        });
    }
}

function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;

    // Remove existing listeners
    uploadArea.removeEventListener('dragover', handleDragOver);
    uploadArea.removeEventListener('dragleave', handleDragLeave);
    uploadArea.removeEventListener('drop', handleDrop);

    // Add new listeners
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    uploadFiles(files);
}

// Initialize drag and drop on page load
setupDragAndDrop();
</script>
{% endblock %}