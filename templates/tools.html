{% extends "base.html" %}

{% block title %}PDF Tools - Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">PDF Processing Tools</h1>
                <div>
                    <span class="badge bg-primary">Welcome, {{ user.first_name }}!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 bg-transparent">
                <div class="card-body p-0">
                    <div class="upload-area shadow-sm" id="uploadArea">
                        <div class="mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-circle p-4 mb-3">
                                <i class="fas fa-cloud-upload-alt text-primary" style="font-size: 3.5rem;"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold mb-3">Ready to process?</h2>
                        <p class="text-muted fs-5 mb-4">Drag & drop your files here or use the button below</p>
                        <button class="btn btn-primary btn-lg px-5 shadow-sm mb-4" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-plus me-2"></i>Choose Files
                        </button>
                        <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
                        <div class="pt-3 border-top mx-5">
                            <small class="text-muted">
                                {% if current_user.is_premium %}
                                    <i class="fas fa-crown text-warning"></i> Premium: Unlimited files, 100MB per file
                                {% else %}
                                    Free Tier: 5MB per file | Max 3 files per batch
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Tools -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">Processing Options</h4>
            <div class="row g-4">
                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-layer-group text-primary mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Merge PDFs</h5>
                            <p class="card-text">Combine multiple PDF files into one document</p>
                            <button class="btn btn-primary" onclick="selectTool('merge')">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-cut text-success mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Split PDFs</h5>
                            <p class="card-text">Split PDF into individual pages</p>
                            <button class="btn btn-success" onclick="selectTool('split')">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-compress text-warning mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Compress PDFs</h5>
                            <p class="card-text">Reduce file size while maintaining quality</p>
                            <button class="btn btn-warning" onclick="selectTool('compress')">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-eye text-info mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">OCR Text Extraction</h5>
                            <p class="card-text">Extract text from scanned PDFs</p>
                            <button class="btn btn-info" onclick="selectTool('ocr')">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-file-word text-primary mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Convert to Word</h5>
                            <p class="card-text">Convert PDF to editable Word document</p>
                            <button class="btn btn-primary" onclick="selectTool('convert_word')">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-file-excel text-success mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Convert to Excel</h5>
                            <p class="card-text">Convert PDF tables to Excel spreadsheet</p>
                            <button class="btn btn-success" onclick="selectTool('convert_excel')">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-lock text-danger mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Protect PDF</h5>
                            <p class="card-text">Add password protection to your PDF</p>
                            <button class="btn btn-danger" onclick="showProtectDialog()">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-redo text-dark mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Rotate PDF</h5>
                            <p class="card-text">Rotate PDF pages by 90, 180, or 270 degrees</p>
                            <button class="btn btn-dark" onclick="showRotateDialog()">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-stamp text-secondary mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Watermark PDF</h5>
                            <p class="card-text">Add text watermark to your PDF pages</p>
                            <button class="btn btn-secondary" onclick="showWatermarkDialog()">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-unlock text-danger mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Unlock PDF</h5>
                            <p class="card-text">Remove password protection from your PDF</p>
                            <button class="btn btn-danger" onclick="showUnlockDialog()">Select</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-images text-success mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="card-title">Extract Images</h5>
                            <p class="card-text">Extract all images from your PDF document</p>
                            <button class="btn btn-success" onclick="selectTool('extract_images')">Select</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Tool Options -->
    <div class="modal fade" id="toolOptionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Tool Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modalConfirmBtn">Start Processing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Jobs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Jobs</h5>
                </div>
                <div class="card-body">
                    {% if recent_jobs %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Job Type</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in recent_jobs %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary">{{ job.job_type.value.title() }}</span>
                                        </td>
                                        <td>
                                            {% if job.status.value == 'completed' %}
                                                <span class="badge bg-success">{{ job.status.value.title() }}</span>
                                            {% elif job.status.value == 'failed' %}
                                                <span class="badge bg-danger">{{ job.status.value.title() }}</span>
                                            {% elif job.status.value == 'processing' %}
                                                <span class="badge bg-info">{{ job.status.value.title() }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">{{ job.status.value.title() }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ job.progress }}%">
                                                    {{ job.progress }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if job.status.value == 'completed' %}
                                                <a href="{{ url_for('download_job_results', job_id=job.id) }}" class="btn btn-sm btn-success">
                                                    <i class="fas fa-download"></i> Download
                                                </a>
                                            {% elif job.status.value in ['pending', 'processing'] %}
                                                <button class="btn btn-sm btn-warning" onclick="cancelJob('{{ job.id }}')">
                                                    <i class="fas fa-times"></i> Cancel
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-history text-muted mb-3" style="font-size: 3rem;"></i>
                            <h5>No recent jobs</h5>
                            <p class="text-muted">Upload files and process them to see your job history</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedTool = null;
let uploadedFiles = [];

// File upload handling
document.getElementById('fileInput').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    uploadFiles(files);
}

function uploadFiles(files) {
    // Validate files before adding them
    const validFiles = [];
    const errors = [];
    
    files.forEach(file => {
        if (file.type !== 'application/pdf') {
            errors.push(`${file.name} is not a PDF file`);
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            errors.push(`${file.name} exceeds 10MB size limit`);
            return;
        }
        
        validFiles.push(file);
    });
    
    if (errors.length > 0) {
        showMessage('File validation errors: ' + errors.join(', '), 'error');
        return;
    }
    
    if (validFiles.length > 5) {
        showMessage('Maximum 5 files allowed per batch', 'warning');
        return;
    }
    
    uploadedFiles = validFiles;
    updateUploadArea();
    
    if (validFiles.length > 0) {
        showMessage(`${validFiles.length} file(s) ready for processing`, 'success');
    }
}

function updateUploadArea() {
    const uploadArea = document.getElementById('uploadArea');
    if (uploadedFiles.length > 0) {
        let filesList = '';
        uploadedFiles.forEach((file, index) => {
            filesList += `<div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-white border rounded shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="bg-danger bg-opacity-10 rounded p-2 me-3">
                        <i class="fas fa-file-pdf text-danger fs-4"></i>
                    </div>
                    <div>
                        <div class="fw-bold text-dark">${file.name}</div>
                        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                </div>
                <button class="btn btn-link text-muted p-0" onclick="removeFile(${index})">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>`;
        });
        
        uploadArea.innerHTML = `
            <div class="text-start">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0">${uploadedFiles.length} file(s) selected</h4>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearFiles()">
                        <i class="fas fa-times me-1"></i> Clear All
                    </button>
                </div>
                <div class="mt-3" style="max-height: 400px; overflow-y: auto;">
                    ${filesList}
                </div>
                <div class="mt-4 pt-4 border-top text-center">
                    <p class="text-muted">Choose a tool below to process these files</p>
                </div>
            </div>
        `;
    }
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    if (uploadedFiles.length === 0) {
        clearFiles();
    } else {
        updateUploadArea();
    }
}

function clearFiles() {
    uploadedFiles = [];
    selectedTool = null;
    
    // Clear the file input value safely
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.value = '';
    }
    
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt mb-3" style="font-size: 3rem; color: #6c757d;"></i>
        <h5>Drag & Drop PDF Files</h5>
        <p class="text-muted">or <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">Browse Files</button></p>
        <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
        <div class="mt-3">
            <small class="text-muted">
                {% if current_user.has_active_subscription() %}
                    <i class="fas fa-crown text-warning"></i> Premium: Unlimited files, no size restrictions
                {% else %}
                    Maximum file size: 10MB per file (Free) | Maximum 5 files per batch (Free)
                {% endif %}
            </small>
        </div>
    `;
    
    // Re-attach event listeners after the DOM is updated
    setTimeout(() => {
        const newFileInput = document.getElementById('fileInput');
        if (newFileInput) {
            newFileInput.addEventListener('change', handleFileSelect);
        }
        
        // Re-attach drag and drop listeners
        setupDragAndDrop();
    }, 0);
    
    showMessage('Files cleared successfully', 'info');
}

function selectTool(tool, settings = {}) {
    selectedTool = tool;
    
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    
    // Process files with optional settings
    processFiles(settings);
}

function showProtectDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Protect PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="pdfPassword" class="form-control" placeholder="Enter password to protect PDF">
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const password = document.getElementById('pdfPassword').value;
        if (!password) {
            alert('Please enter a password');
            return;
        }
        modal.hide();
        selectTool('protect', { password: password });
    };
    modal.show();
}

function showRotateDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Rotate PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Rotation Angle</label>
            <select id="pdfRotation" class="form-select">
                <option value="90">90° Clockwise</option>
                <option value="180">180°</option>
                <option value="270">270° Clockwise</option>
            </select>
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const rotation = document.getElementById('pdfRotation').value;
        modal.hide();
        selectTool('rotate', { rotation: rotation });
    };
    modal.show();
}

function showWatermarkDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Watermark PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Watermark Text</label>
            <input type="text" id="watermarkText" class="form-control" placeholder="CONFIDENTIAL" value="CONFIDENTIAL">
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const text = document.getElementById('watermarkText').value;
        if (!text) {
            alert('Please enter watermark text');
            return;
        }
        modal.hide();
        selectTool('watermark', { watermark_text: text });
    };
    modal.show();
}

function showUnlockDialog() {
    if (uploadedFiles.length === 0) {
        showMessage('Please upload files first', 'warning');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('toolOptionsModal'));
    document.getElementById('modalTitle').innerText = 'Unlock PDF';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="unlockPassword" class="form-control" placeholder="Enter password to unlock PDF">
        </div>
    `;
    document.getElementById('modalConfirmBtn').onclick = () => {
        const password = document.getElementById('unlockPassword').value;
        if (!password) {
            alert('Please enter the password');
            return;
        }
        modal.hide();
        selectTool('unlock', { password: password });
    };
    modal.show();
}

function processFiles(settings = {}) {
    // Show processing indicator
    setProcessingState(true);
    
    // First upload the files
    const formData = new FormData();
    for (let file of uploadedFiles) {
        formData.append('files', file);
    }
    
    // Upload files first
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.files) {
            // Files uploaded successfully, now process them
            const fileIds = data.files.map(file => file.id);
            
            // Create processing job
            return fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    job_type: selectedTool,
                    file_ids: fileIds,
                    settings: settings
                })
            });
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    })
    .then(response => response.json())
    .then(data => {
        setProcessingState(false);
        if (data.job_id) {
            showMessage('Processing started successfully! Your files are being processed.', 'success');
            clearFiles();
            setTimeout(() => location.reload(), 2000);
        } else {
            showMessage('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        setProcessingState(false);
        showMessage('An error occurred: ' + error.message, 'error');
    });
}

function cancelJob(jobId) {
    if (confirm('Are you sure you want to cancel this job?')) {
        fetch(`/cancel-job/${jobId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Job cancelled successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while cancelling the job', 'error');
        });
    }
}

function showMessage(message, type) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.custom-message');
    existingMessages.forEach(msg => msg.remove());
    
    // Create new message
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type} alert-dismissible fade show custom-message`;
    messageDiv.style.position = 'fixed';
    messageDiv.style.top = '20px';
    messageDiv.style.right = '20px';
    messageDiv.style.zIndex = '9999';
    messageDiv.style.minWidth = '300px';
    
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(messageDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentElement) {
            messageDiv.remove();
        }
    }, 5000);
}

function setProcessingState(processing) {
    const toolButtons = document.querySelectorAll('.tool-card button');
    const uploadArea = document.getElementById('uploadArea');
    
    if (processing) {
        // Disable all tool buttons
        toolButtons.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        });
        
        // Show processing message in upload area
        if (uploadedFiles.length > 0) {
            uploadArea.innerHTML = `
                <i class="fas fa-spinner fa-spin text-primary mb-3" style="font-size: 3rem;"></i>
                <h5>Processing Files...</h5>
                <p class="text-muted">Please wait while your files are being processed</p>
            `;
        }
    } else {
        // Re-enable tool buttons
        toolButtons.forEach((btn, index) => {
            btn.disabled = false;
            const toolNames = ['Select', 'Select', 'Select', 'Select', 'Select', 'Select'];
            const toolTypes = ['merge', 'split', 'compress', 'ocr', 'convert_word', 'convert_excel'];
            btn.innerHTML = 'Select';
            btn.onclick = () => selectTool(toolTypes[index]);
        });
    }
}

function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;

    // Remove existing listeners
    uploadArea.removeEventListener('dragover', handleDragOver);
    uploadArea.removeEventListener('dragleave', handleDragLeave);
    uploadArea.removeEventListener('drop', handleDrop);

    // Add new listeners
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    uploadFiles(files);
}

// Initialize drag and drop on page load
setupDragAndDrop();
</script>
{% endblock %}